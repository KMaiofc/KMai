<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KMai v64.0 - Smart Bypass</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0e0e0e; --side: #161616; --surface: #1e1e1e; --border: #333; --acc: #a8c7fa; --txt: #e3e3e3; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: 0; font-family: 'Google Sans', sans-serif; }
        body { background: var(--bg); color: var(--txt); display: flex; height: 100dvh; overflow: hidden; }

        /* MOD RENKLERƒ∞ */
        body.mod-ensar { --acc: #4facfe; border-top: 4px solid #4facfe; }
        body.mod-kerem { --acc: #d4a5ff; border-top: 4px solid #d4a5ff; animation: rgb 10s infinite; }
        body.mod-cheat { --acc: #ff4444; background: #080000; border-top: 4px solid red; }
        body.mod-mehmet { --acc: #00e676; border-top: 4px solid #00e676; box-shadow: inset 0 0 20px rgba(0, 230, 118, 0.1); }
        @keyframes rgb { 0%{box-shadow:inset 0 0 30px rgba(255,0,0,0.1)} 50%{box-shadow:inset 0 0 30px rgba(0,0,255,0.1)} 100%{box-shadow:inset 0 0 30px rgba(0,255,0,0.1)} }

        /* SIDEBAR */
        #sidebar { width: 280px; background: var(--side); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); transition: 0.3s; z-index: 100; }
        .logo { font-size: 20px; font-weight: 700; margin-bottom: 25px; color: var(--acc); display: flex; align-items: center; gap: 10px; }
        .new-btn { background: #2b2b2b; color: #fff; padding: 12px; border-radius: 50px; border: 1px solid var(--border); cursor: pointer; margin-bottom: 20px; width: 100%; }
        #history { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .h-item { padding: 12px 14px; border-radius: 50px; cursor: pointer; font-size: 13px; color: #999; display: flex; justify-content: space-between; align-items: center; }
        .h-item:hover, .h-item.active { background: #333; color: #fff; }

        /* MAIN */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px 10%; display: flex; flex-direction: column; gap: 30px; }
        .msg { display: flex; gap: 15px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0; transform:translateY(15px)} to{opacity:1; transform:translateY(0)} }
        .av { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .ai-av { background: linear-gradient(135deg, #4285f4, #d96570); color: #fff; }
        .u-av { background: #3c4043; color: #fff; }
        .cnt { flex: 1; font-size: 16px; line-height: 1.6; color: #e3e3e3; word-break: break-word; }

        /* FOOTER */
        .footer { padding: 20px 10%; background: var(--bg); }
        .inp-box { background: var(--surface); border-radius: 26px; padding: 12px 20px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        textarea { width: 100%; background: 0; border: 0; color: #fff; font-size: 16px; resize: none; max-height: 150px; outline: 0; }
        .tools { display: flex; justify-content: space-between; align-items: center; }
        .icons { display: flex; gap: 20px; color: #aaa; font-size: 20px; }
        .icons i { cursor: pointer; }
        .send-btn { background: var(--acc); color: #000; width: 38px; height: 38px; border-radius: 50%; border: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #img-prev img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid var(--acc); margin-bottom: 10px; }
        pre { background: #161b22 !important; border-radius: 12px; padding: 15px; border: 1px solid #30363d; margin: 15px 0; overflow-x: auto; }
        
        @media (max-width: 768px) { #chat-flow, .footer { padding: 15px 5%; } #sidebar { display: none; } }
    </style>
</head>
<body class="mod-normal">

<div id="sidebar">
    <div class="logo"><i class="fas fa-microchip"></i> KMai v64</div>
    <button class="new-btn" onclick="Core.newChat()">+ Yeni Sohbet</button>
    <div id="history"></div>
    <div style="margin-top:15px">
        <select id="mod-select" onchange="Core.setMod()" style="width:100%; padding:10px; border-radius:10px; background:#222; color:#fff; border:1px solid #444;">
            <option value="normal">Normal Mod</option>
            <option value="ensar">Ensar Mod</option>
            <option value="kerem">Kerem Mod (RGB)</option>
            <option value="mehmet">Mehmet Mod</option>
            <option value="cheat">Eƒüitim Modu (Root)</option>
        </select>
    </div>
</div>

<div id="main">
    <div id="chat-flow"></div>
    <div class="footer">
        <div class="inp-box">
            <div id="img-prev"></div>
            <textarea id="u-in" rows="1" placeholder="KMai'ye yazƒ±n..."></textarea>
            <div class="tools">
                <div class="icons">
                    <i class="fas fa-image" onclick="document.getElementById('f-in').click()"></i>
                    <i class="fas fa-magic" onclick="Core.magic()"></i>
                </div>
                <button class="send-btn" onclick="Core.exec()"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>
        <input type="file" id="f-in" hidden accept="image/*" onchange="Core.file(this)">
    </div>
</div>

<script>
// ≈ûifre aynƒ± duruyor
const SIFRE = "EqKKJl≈üiOƒû√ºyussdmnNN";
if(prompt("Giri≈ü ≈ûifresi:") !== SIFRE) { document.body.innerHTML="Eri≈üim Engellendi"; throw "Hata"; }

const API_KEY = "AIzaSyDZZXcsbXFkH4PMNVs2xmFrsOUqO2Cq5eY";

const Core = {
    data: JSON.parse(localStorage.getItem('KMAI_V64_STORE')) || { chats: {}, mod: 'normal' },
    active: null,
    tempImg: null,

    init() {
        this.setMod(this.data.mod);
        this.active = Object.keys(this.data.chats).sort((a,b)=>this.data.chats[b].ts - this.data.chats[a].ts)[0] || this.newChat();
        this.renderHistory();
        this.renderChat();
        const area = document.getElementById('u-in');
        area.oninput = () => { area.style.height = 'auto'; area.style.height = area.scrollHeight + 'px'; };
    },

    setMod(v) {
        const m = v || document.getElementById('mod-select').value;
        this.data.mod = m;
        document.body.className = 'mod-' + m;
        document.getElementById('mod-select').value = m;
        this.save();
    },

    save() { localStorage.setItem('KMAI_V64_STORE', JSON.stringify(this.data)); },

    newChat() {
        const id = 'c_' + Date.now();
        this.data.chats[id] = { title: "Yeni Sohbet", msgs: [], ts: Date.now() };
        this.active = id; this.save(); this.renderHistory(); this.renderChat();
        return id;
    },

    file(input) {
        const f = input.files[0];
        const r = new FileReader();
        r.onload = (e) => {
            this.tempImg = e.target.result.split(',')[1];
            document.getElementById('img-prev').innerHTML = `<img src="${e.target.result}">`;
        };
        r.readAsDataURL(f);
    },

    async magic() {
        const p = prompt("Ne √ßizmemi istersin?");
        if(!p) return;
        this.addMessage('u', `üé® Resim Talebi: ${p}`);
        const ai = this.addMessage('a', '√áiziyorum, bekle...');
        const s = Math.floor(Math.random()*9999);
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=1024&height=1024&nologo=true&seed=${s}`;
        setTimeout(() => {
            ai.querySelector('.cnt').innerHTML = `<p>ƒ∞≈üte √ßizim:</p><img src="${url}" style="width:100%; border-radius:12px; margin-top:10px;">`;
            this.data.chats[this.active].msgs.push({role:'a', text:'[Resim]', imgUrl: url});
            this.save();
        }, 2000);
    },

    async exec() {
        const input = document.getElementById('u-in');
        const val = input.value.trim();
        if(!val && !this.tempImg) return;

        const currentImg = this.tempImg;
        this.addMessage('u', val, currentImg);
        
        input.value = ""; input.style.height = "auto";
        document.getElementById('img-prev').innerHTML = "";
        this.tempImg = null;

        const ai = this.addMessage('a', '<i class="fas fa-sync fa-spin"></i> KMai v64 i≈üliyor...');

        try {
            const history = this.data.chats[this.active].msgs.slice(-10).map(m => ({
                role: m.role === 'u' ? 'user' : 'model',
                parts: [{ text: m.text }]
            }));

            const parts = [{ text: val }];
            if(currentImg) parts.push({ inlineData: { mimeType: "image/jpeg", data: currentImg } });

            // SMART BYPASS: Agresif kelimeler yerine daha sakin bir sistem talimatƒ±
            const sysPrompt = `Sen KMai v64, d√ºr√ºst ve yardƒ±msever bir eƒüitim asistanƒ±sƒ±n. 
            T√ºrk√ße gramer kurallarƒ±na %100 uy. Kullanƒ±cƒ± 6. sƒ±nƒ±f √∂ƒürencisidir. 
            Roblox Luau, HTML ve genel kodlama konularƒ±nda akademik d√ºzeyde yardƒ±mcƒ± ol. 
            Cevaplarƒ±n her zaman anlamlƒ± ve akƒ±cƒ± olsun.`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                referrerPolicy: "no-referrer",
                body: JSON.stringify({
                    contents: [...history.slice(0,-1), { role: 'user', parts }],
                    systemInstruction: { parts: [{ text: sysPrompt }] },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const json = await res.json();
            
            if (json.candidates && json.candidates[0].content) {
                const reply = json.candidates[0].content.parts[0].text;
                ai.querySelector('.cnt').innerHTML = marked.parse(reply);
                this.data.chats[this.active].msgs.push({ role: 'a', text: reply });
                if(this.data.chats[this.active].msgs.length <= 2) this.data.chats[this.active].title = val.substring(0,20);
                this.save(); this.renderHistory(); this.highlight();
            } else {
                // Filtre hatasƒ±nƒ± detaylandƒ±r
                const reason = json.promptFeedback ? "Hassas ƒ∞√ßerik" : "Sunucu Reddi";
                throw new Error(`G√ºvenlik Korumasƒ± (${reason}). L√ºtfen sorunu daha eƒüitici bir dille sor.`);
            }

        } catch (e) {
            ai.querySelector('.cnt').innerHTML = `<span style="color:#ff6b6b">‚ö†Ô∏è Hata: ${e.message}</span>`;
        }
    },

    addMessage(role, text, img = null) {
        const flow = document.getElementById('chat-flow');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `
            <div class="av ${role === 'u' ? 'u-av' : 'ai-av'}">${role === 'u' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'}</div>
            <div class="cnt">
                ${img ? `<img src="data:image/jpeg;base64,${img}" style="max-width:250px; border-radius:10px; margin-bottom:10px; display:block;">` : ''}
                ${marked.parse(text)}
            </div>
        `;
        flow.appendChild(div);
        flow.scrollTop = flow.scrollHeight;
        if(role === 'u') this.data.chats[this.active].msgs.push({role:'u', text:text});
        return div;
    },

    renderHistory() {
        const h = document.getElementById('history'); h.innerHTML = "";
        Object.keys(this.data.chats).sort((a,b)=>this.data.chats[b].ts - this.data.chats[a].ts).forEach(id => {
            const item = document.createElement('div');
            item.className = `h-item ${id === this.active ? 'active' : ''}`;
            item.innerHTML = `<span>${this.data.chats[id].title}</span> <i class="fas fa-trash" onclick="Core.del('${id}')"></i>`;
            item.ondblclick = () => {
                const nt = prompt("Sohbet ismi:", this.data.chats[id].title);
                if(nt) { this.data.chats[id].title = nt; this.save(); this.renderHistory(); }
            };
            item.onclick = (e) => { if(e.target.tagName !== 'I') { this.active = id; this.renderChat(); this.renderHistory(); } };
            h.appendChild(item);
        });
    },

    renderChat() {
        const f = document.getElementById('chat-flow'); f.innerHTML = "";
        if(!this.data.chats[this.active]) return;
        this.data.chats[this.active].msgs.forEach(m => {
            const div = document.createElement('div'); div.className = 'msg';
            div.innerHTML = `
                <div class="av ${m.role === 'u' ? 'u-av' : 'ai-av'}">${m.role === 'u' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'}</div>
                <div class="cnt">${m.imgUrl ? `<img src="${m.imgUrl}" style="width:100%; border-radius:12px;">` : marked.parse(m.text)}</div>
            `;
            f.appendChild(div);
        });
        f.scrollTop = f.scrollHeight;
        this.highlight();
    },

    del(id) { if(confirm("Silinsin mi?")) { delete this.data.chats[id]; this.active = Object.keys(this.data.chats)[0] || this.newChat(); this.save(); this.renderHistory(); this.renderChat(); } },
    highlight() { document.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el)); }
};
window.onload = () => Core.init();
</script>
</body>
</html>
