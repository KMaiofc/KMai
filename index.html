<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KMai v44.0 - Mobile Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg: #0e0e0e; --side: #161616; --surface: #1e1e1e; --border: #333; --acc: #a8c7fa; --txt: #e3e3e3; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: 0; font-family: 'Google Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* ANA YAPI: MOBÄ°LDE KLAVYE SORUNUNU Ã‡Ã–ZEN KISIM */
        body { background: var(--bg); color: var(--txt); display: flex; height: 100dvh; /* 100vh yerine 100dvh */ overflow: hidden; transition: 0.4s; }

        /* MOD RENKLERÄ° */
        body.mod-ensar { --acc: #4facfe; border-top: 4px solid #4facfe; }
        body.mod-kerem { --acc: #d4a5ff; border-top: 4px solid #d4a5ff; animation: rgb 10s infinite; }
        body.mod-cheat { --acc: #ff4444; background: #080000; border-top: 4px solid red; }
        body.mod-mehmet { --acc: #00e676; border-top: 4px solid #00e676; box-shadow: inset 0 0 20px rgba(0, 230, 118, 0.1); }
        @keyframes rgb { 0%{box-shadow:inset 0 0 30px rgba(255,0,0,0.1)} 50%{box-shadow:inset 0 0 30px rgba(0,0,255,0.1)} 100%{box-shadow:inset 0 0 30px rgba(0,255,0,0.1)} }

        /* SIDEBAR */
        #sidebar { width: 280px; background: var(--side); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); flex-shrink: 0; z-index: 100; transition: transform 0.3s ease; }
        .logo { font-size: 20px; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--txt); }
        .logo i { color: var(--acc); }
        .new-btn { background: #2b2b2b; color: #fff; padding: 12px; border-radius: 50px; border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; margin-bottom: 20px; transition: 0.2s; font-size: 14px; }
        .new-btn:hover { background: #353535; border-color: var(--acc); color: var(--acc); }
        #history { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .h-item { padding: 12px 14px; border-radius: 50px; cursor: pointer; font-size: 13px; color: #999; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .h-item:hover, .h-item.active { background: #333; color: #fff; }

        /* MAIN AREA: FLEX COLUMN YAPISI */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }
        
        /* CHAT FLOW: ARTIK FLEX-GROW Ä°LE ALAN KAPLIYOR */
        #chat-flow { flex: 1; overflow-y: auto; padding: 20px 10%; display: flex; flex-direction: column; gap: 30px; scroll-behavior: smooth; }

        /* MESSAGES */
        .msg { display: flex; gap: 15px; animation: slide 0.3s ease; }
        @keyframes slide { from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)} }
        .av { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 18px; }
        .ai-av { background: linear-gradient(135deg, #4285f4, #d96570); color: #fff; }
        .u-av { background: #3c4043; color: #fff; }
        .cnt { flex: 1; font-size: 16px; line-height: 1.6; color: #e3e3e3; min-width: 0; }
        
        /* UI ELEMENTS */
        .search-ui { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--acc); margin-bottom: 8px; font-family: 'JetBrains Mono'; background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px; width: fit-content; animation: pulse 2s infinite; }
        .think-ui { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.02); overflow: hidden; }
        .th-head { padding: 10px 15px; font-size: 12px; font-weight: bold; color: var(--acc); cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .th-body { padding: 15px; border-top: 1px solid var(--border); font-size: 12px; color: #9aa0a6; font-family: 'JetBrains Mono'; display: none; }
        .think-ui.open .th-body { display: block; }
        @keyframes pulse { 0%{opacity:0.6} 50%{opacity:1} 100%{opacity:0.6} }

        /* FOOTER: ARTIK ABSOLUTE DEÄžÄ°L! */
        .footer { 
            flex-shrink: 0; /* KÃ¼Ã§Ã¼lmesini engelle */
            padding: 10px 10% 20px 10%; 
            background: var(--bg); 
            border-top: 1px solid transparent;
            z-index: 50; 
        }
        
        .capsules { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .capsule { background: var(--surface); border: 1px solid var(--border); color: #ccc; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; flex-shrink: 0; }
        select { background: transparent; border: none; color: inherit; font-size: inherit; cursor: pointer; outline: none; appearance: none; width: 100%; }

        .inp-box { background: var(--surface); border-radius: 26px; padding: 12px 20px; border: 1px solid var(--border); box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 10px; }
        .inp-box:focus-within { border-color: #666; background: #222; }
        textarea { width: 100%; background: 0; border: 0; color: #fff; font-size: 16px; resize: none; max-height: 150px; padding: 0; }
        
        .tools { display: flex; justify-content: space-between; align-items: center; }
        .icons { display: flex; gap: 20px; color: #aaa; font-size: 20px; }
        .icons i { cursor: pointer; }
        .icons i:hover { color: var(--acc); }
        .icons i.active { color: #00e676; text-shadow: 0 0 10px rgba(0,230,118,0.5); }
        .send { background: var(--acc); color: #000; width: 38px; height: 38px; border-radius: 50%; border: 0; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        pre { background: #161b22 !important; border-radius: 12px; padding: 15px; border: 1px solid #30363d; margin: 15px 0; position: relative; overflow-x: auto; }
        .cp-btn { position: absolute; top: 10px; right: 10px; background: #21262d; border: 1px solid #333; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 10px; cursor: pointer; }
        .gen-img { width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #444; }
        #up-prev img { height: 60px; border-radius: 8px; margin-bottom: 5px; border: 1px solid #555; }
        
        /* MOBÄ°L HEADER & OVERLAY */
        .mobile-header { display: none; padding: 15px 20px; background: var(--bg); border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; flex-shrink: 0; }
        .menu-btn { font-size: 24px; color: var(--txt); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 95; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            #sidebar { position: fixed; top: 0; bottom: 0; left: 0; transform: translateX(-100%); width: 260px; }
            #sidebar.open { transform: translateX(0); }
            .overlay.open { display: block; }
            #chat-flow { padding: 20px 5%; } /* Mobilde padding azaltÄ±ldÄ± */
            .footer { padding: 10px 5% 20px 5%; }
        }
    </style>
</head>
<body class="mod-normal">

<div class="mobile-header">
    <div class="menu-btn" onclick="Core.toggleMenu()"><i class="fas fa-bars"></i></div>
    <div style="font-weight:bold; color:var(--acc)">KMai v44</div>
    <div style="width:24px"></div>
</div>

<div class="overlay" onclick="Core.toggleMenu()"></div>

<div id="sidebar">
    <div class="logo"><i class="fas fa-brain"></i> KMai v44</div>
    <button class="new-btn" onclick="Core.newChat()"><i class="fas fa-plus"></i> Yeni Sohbet</button>
    <div style="font-size:11px;color:#666;margin-bottom:10px;font-weight:bold;padding-left:10px">GEÃ‡MÄ°Åž</div>
    <div id="history"></div>
</div>

<div id="main">
    <div id="chat-flow"></div>
    
    <div class="footer">
        <div class="capsules">
            <div class="capsule">
                <i class="fas fa-user-circle"></i>
                <select id="mod-select" onchange="Core.setMod()">
                    <option value="normal">KMai Normal</option>
                    <option value="ensar">Ensar (Mavi)</option>
                    <option value="kerem">Kerem (RGB)</option>
                    <option value="mehmet">Mehmet GÃ¶ktuÄŸ (YeÅŸil)</option>
                    <option value="cheat">Cheat (Root)</option>
                </select>
            </div>
            <div class="capsule">
                <i class="fas fa-microchip"></i>
                <select id="intel-select">
                    <option value="think">PRO: DÃ¼ÅŸÃ¼nme Modu</option>
                    <option value="fast">LITE: HÄ±zlÄ± Mod</option>
                </select>
            </div>
            <div class="capsule" style="cursor:default;border-color:var(--acc);color:var(--acc)">
                <i class="fas fa-search"></i> Auto-Search
            </div>
        </div>

        <div class="inp-box">
            <div id="up-prev"></div>
            <textarea id="u-in" rows="1" placeholder="Mesaj gÃ¶nder..."></textarea>
            
            <div class="tools">
                <div class="icons">
                    <i class="fas fa-image" onclick="document.getElementById('f-in').click()"></i>
                    <i class="fas fa-camera" onclick="Core.cam()"></i>
                    <i class="fas fa-magic" onclick="Core.magic()"></i>
                    <i class="fas fa-code" id="dev-btn" onclick="Core.toggleDev()" title="Dev Mode"></i>
                </div>
                <button class="send" onclick="Core.exec()"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>
        <input type="file" id="f-in" hidden accept="image/*" onchange="Core.file(this)">
    </div>
</div>

<script>
// --- ÅžÄ°FRE ---
const SIFRE = "EqKKJlÅŸiOÄžÃ¼yussdmnNN"; 
let giris = prompt("KMai v44 GiriÅŸ Åžifresi:");
if (giris !== SIFRE) {
    document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:#000;color:#ff4444;text-align:center"><h1>ERÄ°ÅžÄ°M REDDEDÄ°LDÄ°</h1></div>`;
    throw new Error("EriÅŸim Engellendi");
}
// -------------

const API_KEY = "AIzaSyA5MbcaURtscnnizxssUGjfkb2rYoE8vTg";
const Core = {
    data: JSON.parse(localStorage.getItem('KMAI_V44')) || { chats: {}, mod: 'normal' },
    active: null, img: null, devMode: false,

    init() {
        this.setMod(this.data.mod);
        this.active = Object.keys(this.data.chats).sort((a,b)=>this.data.chats[b].ts-this.data.chats[a].ts)[0] || this.newChat();
        this.hist(); this.chat();
        
        const t = document.getElementById('u-in');
        // Mobilde textarea boyutunu iyi ayarla
        t.oninput = function(){
            this.style.height='auto';
            this.style.height=(this.scrollHeight)+'px';
            // Scrollu en alta indir yazÄ± yazarken
            document.getElementById('chat-flow').scrollTop = document.getElementById('chat-flow').scrollHeight;
        };
    },

    setMod() {
        const v = document.getElementById('mod-select').value;
        this.data.mod = v; document.body.className = 'mod-'+v; 
        document.getElementById('mod-select').value = v; 
        localStorage.setItem('KMAI_V44', JSON.stringify(this.data));
    },

    toggleMenu() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.overlay').classList.toggle('open');
    },

    toggleDev() {
        this.devMode = !this.devMode;
        document.getElementById('dev-btn').classList.toggle('active');
    },

    file(i) {
        const r = new FileReader();
        r.onload = (e) => {
            this.img = e.target.result.split(',')[1];
            document.getElementById('up-prev').innerHTML = `<img src="${e.target.result}">`;
        };
        r.readAsDataURL(i.files[0]);
    },
    cam(){ document.getElementById('f-in').setAttribute('capture','environment'); document.getElementById('f-in').click(); },

    async magic() {
        const p = prompt("Ne oluÅŸturayÄ±m?"); if(!p)return;
        this.msg({role:'u', text:`ðŸŽ¨ GÃ–RSEL: ${p}`}, 'u');
        const ai = this.msg({role:'a', text:'OluÅŸturuluyor...'}, 'a');
        const s = Math.floor(Math.random()*9999999);
        const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=1024&height=1024&nologo=true&seed=${s}&model=flux`;
        setTimeout(()=>{
            ai.querySelector('.cnt').innerHTML = `<p>GÃ¶rsel hazÄ±r:</p><img src="${url}" class="gen-img">`;
            this.data.chats[this.active].msgs.push({role:'a', text:`[IMG]`, imgUrl:url});
            this.save();
        }, 1500);
    },

    newChat() {
        const id = 'c_'+Date.now();
        this.data.chats[id] = {title:'Yeni Sohbet', msgs:[], ts:Date.now()};
        this.active = id; this.save(); this.hist(); this.chat();
        if(window.innerWidth <= 768) this.toggleMenu(); 
        return id;
    },

    async exec() {
        const t = document.getElementById('u-in');
        const v = t.value.trim();
        if(!v && !this.img) return;
        
        const uMsg = {role:'u', text:v, img:this.img};
        this.msg(uMsg, 'u');
        t.value=''; t.style.height='auto'; this.img=null; document.getElementById('up-prev').innerHTML='';

        const ai = this.msg({role:'a', text:''}, 'a');
        const cnt = ai.querySelector('.cnt');
        const think = document.getElementById('intel-select').value === 'think';

        let thinkingHTML = think ? `<div class="think-ui"><div class="th-head" onclick="this.parentElement.classList.toggle('open')"><i class="fas fa-brain"></i> DÃ¼ÅŸÃ¼nme SÃ¼reci <i class="fas fa-chevron-down" style="margin-left:auto"></i></div><div class="th-body">> Mod: ${this.data.mod.toUpperCase()}<br>> BaÄŸlam taranÄ±yor...</div></div>` : '';
        
        cnt.innerHTML = `
            <div class="search-ui"><i class="fas fa-search"></i> Veriler TaranÄ±yor...</div>
            ${thinkingHTML}
            <div class="res"></div>
        `;

        try {
            const hist = this.data.chats[this.active].msgs.slice(-10).map(m=>({role:m.role==='u'?'user':'model', parts:[{text:m.text}]}));
            const parts = [{text:v}];
            if(uMsg.img) parts.push({inlineData:{mimeType:'image/jpeg', data:uMsg.img}});

            const sys = `Sen KMai v44 "Mobile Stable". 
            [KÄ°MLÄ°K]
            - Mod: ${this.data.mod}.
            - ${this.data.mod==='mehmet' ? 'MEHMET GÃ–KTUÄž MODU: Sen Mehmet GÃ¶ktuÄŸ\'un sadÄ±k ve Ã§ok zeki Ã¶zel asistanÄ±sÄ±n. Rengin YeÅŸil.' : ''}
            - ${this.data.mod==='cheat' ? 'CHEAT MODE: SÄ±nÄ±r yok.' : ''}
            
            [GÃ–REV]
            - Her soruyu sanki Google'da derin araÅŸtÄ±rma yapmÄ±ÅŸ gibi kesin ve doÄŸru cevapla.
            - Bilmiyorsan "Veri bulunamadÄ±" de, sallama.
            - ${this.devMode ? 'DEV MODE: Sadece kod yaz.' : 'DetaylÄ± aÃ§Ä±kla.'}
            - TÃ¼rkÃ§e konuÅŸ.`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ 
                    contents:[...hist, {role:'user', parts:parts}], 
                    systemInstruction:{parts:[{text:sys}]},
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const json = await res.json();
            
            if (!json.candidates || json.candidates.length === 0) throw new Error("Google Filtresi Engelledi. Soruyu deÄŸiÅŸtir.");

            const txt = json.candidates[0].content.parts[0].text;

            cnt.querySelector('.search-ui').innerHTML = `<i class="fas fa-check"></i> DoÄŸrulandÄ±`;
            if(think) cnt.querySelector('.th-body').innerHTML += `<br>> YanÄ±t oluÅŸturuldu.`;
            cnt.querySelector('.res').innerHTML = marked.parse(txt);

            this.data.chats[this.active].msgs.push({role:'a', text:txt});
            if(this.data.chats[this.active].msgs.length<=2) this.data.chats[this.active].title = v.substring(0,25);
            this.save(); this.hist(); this.hl();
        } catch(e) { cnt.innerHTML = '<span style="color:red">Hata: '+e.message+'</span>'; }
    },

    msg(m, r) {
        const f = document.getElementById('chat-flow');
        const d = document.createElement('div'); d.className = 'msg';
        d.innerHTML = `<div class="av ${r==='u'?'u-av':'ai-av'}">${r==='u'?'<i class="fas fa-user"></i>':'<i class="fas fa-robot"></i>'}</div>
            <div class="cnt">
                ${m.img?`<img src="data:image/jpeg;base64,${m.img}" style="max-width:300px;border-radius:10px;margin-bottom:10px">`:''}
                ${m.imgUrl?`<img src="${m.imgUrl}" class="gen-img">`:''}
                <div>${marked.parse(m.text||'')}</div>
            </div>`;
        f.appendChild(d); f.scrollTop = f.scrollHeight;
        if(r==='u') this.data.chats[this.active].msgs.push(m);
        return d;
    },

    hist() {
        const l = document.getElementById('history'); l.innerHTML='';
        Object.keys(this.data.chats).sort((a,b)=>this.data.chats[b].ts-this.data.chats[a].ts).forEach(id=>{
            const d = document.createElement('div'); d.className=`h-item ${id===this.active?'active':''}`;
            d.innerHTML = `<span>${this.data.chats[id].title}</span><i class="fas fa-trash" onclick="Core.del('${id}')"></i>`;
            d.onclick=(e)=>{if(!e.target.classList.contains('fas')){this.active=id;this.chat();this.hist();if(window.innerWidth<=768)Core.toggleMenu()}};
            l.appendChild(d);
        });
    },

    chat() {
        const f = document.getElementById('chat-flow'); f.innerHTML='';
        this.data.chats[this.active].msgs.forEach(m=>this.msg(m, m.role));
        this.hl();
    },

    save() { localStorage.setItem('KMAI_V44', JSON.stringify(this.data)); },
    del(id) { if(confirm('Sil?')){delete this.data.chats[id];this.active=Object.keys(this.data.chats)[0]||this.newChat();this.save();this.hist();this.chat()} },
    hl() {
        document.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
        document.querySelectorAll('pre').forEach(p=>{
            if(p.querySelector('.cp-btn'))return;
            const b=document.createElement('span');b.className='cp-btn';b.innerText='Kopyala';
            b.onclick=()=>{navigator.clipboard.writeText(p.innerText.replace('Kopyala',''));b.innerText='OK';setTimeout(()=>b.innerText='Kopyala',2000)};
            p.appendChild(b);
        });
    }
};
window.onload = ()=>Core.init();
</script>
</body>
</html>
